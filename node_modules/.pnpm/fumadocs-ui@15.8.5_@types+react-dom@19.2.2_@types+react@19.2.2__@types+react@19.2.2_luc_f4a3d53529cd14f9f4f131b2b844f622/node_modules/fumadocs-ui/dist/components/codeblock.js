'use client';
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { Check, Clipboard } from '../icons.js';
import { createContext, useContext, useMemo, useRef, } from 'react';
import { cn } from '../utils/cn.js';
import { useCopyButton } from '../utils/use-copy-button.js';
import { buttonVariants } from '../components/ui/button.js';
import { Tabs, TabsContent, TabsList, TabsTrigger, } from '../components/tabs.unstyled.js';
import { mergeRefs } from '../utils/merge-refs.js';
const TabsContext = createContext(null);
export function Pre(props) {
    return (_jsx("pre", { ...props, className: cn('min-w-full w-max *:flex *:flex-col', props.className), children: props.children }));
}
export function CodeBlock({ ref, title, allowCopy = true, keepBackground = false, icon, viewportProps = {}, children, Actions = (props) => (_jsx("div", { ...props, className: cn('empty:hidden', props.className) })), ...props }) {
    const inTab = useContext(TabsContext) !== null;
    const areaRef = useRef(null);
    return (_jsxs("figure", { ref: ref, dir: "ltr", ...props, className: cn(inTab
            ? 'bg-fd-secondary -mx-px -mb-px last:rounded-b-xl'
            : 'my-4 bg-fd-card rounded-xl', keepBackground && 'bg-(--shiki-light-bg) dark:bg-(--shiki-dark-bg)', 'shiki relative border shadow-sm outline-none not-prose overflow-hidden text-sm', props.className), children: [title ? (_jsxs("div", { className: "flex text-fd-muted-foreground items-center gap-2 h-9.5 border-b px-4", children: [typeof icon === 'string' ? (_jsx("div", { className: "[&_svg]:size-3.5", dangerouslySetInnerHTML: {
                            __html: icon,
                        } })) : (icon), _jsx("figcaption", { className: "flex-1 truncate", children: title }), Actions({
                        className: '-me-2',
                        children: allowCopy && _jsx(CopyButton, { containerRef: areaRef }),
                    })] })) : (Actions({
                className: 'absolute top-2 right-2 z-2 backdrop-blur-lg rounded-lg text-fd-muted-foreground',
                children: allowCopy && _jsx(CopyButton, { containerRef: areaRef }),
            })), _jsx("div", { ref: areaRef, ...viewportProps, className: cn('text-[13px] py-3.5 overflow-auto max-h-[600px] fd-scroll-container', viewportProps.className), style: {
                    // space for toolbar
                    '--padding-right': !title ? 'calc(var(--spacing) * 8)' : undefined,
                    counterSet: props['data-line-numbers']
                        ? `line ${Number(props['data-line-numbers-start'] ?? 1) - 1}`
                        : undefined,
                    ...viewportProps.style,
                }, children: children })] }));
}
function CopyButton({ className, containerRef, ...props }) {
    const [checked, onClick] = useCopyButton(() => {
        const pre = containerRef.current?.getElementsByTagName('pre').item(0);
        if (!pre)
            return;
        const clone = pre.cloneNode(true);
        clone.querySelectorAll('.nd-copy-ignore').forEach((node) => {
            node.replaceWith('\n');
        });
        void navigator.clipboard.writeText(clone.textContent ?? '');
    });
    return (_jsx("button", { type: "button", "data-checked": checked || undefined, className: cn(buttonVariants({
            className: 'hover:text-fd-accent-foreground data-[checked]:text-fd-accent-foreground',
            size: 'icon-xs',
        }), className), "aria-label": checked ? 'Copied Text' : 'Copy Text', onClick: onClick, ...props, children: checked ? _jsx(Check, {}) : _jsx(Clipboard, {}) }));
}
export function CodeBlockTabs({ ref, ...props }) {
    const containerRef = useRef(null);
    const nested = useContext(TabsContext) !== null;
    return (_jsx(Tabs, { ref: mergeRefs(containerRef, ref), ...props, className: cn('bg-fd-card rounded-xl border', !nested && 'my-4', props.className), children: _jsx(TabsContext.Provider, { value: useMemo(() => ({
                containerRef,
                nested,
            }), [nested]), children: props.children }) }));
}
export function CodeBlockTabsList(props) {
    return (_jsx(TabsList, { ...props, className: cn('flex flex-row px-2 overflow-x-auto text-fd-muted-foreground', props.className), children: props.children }));
}
export function CodeBlockTabsTrigger({ children, ...props }) {
    return (_jsxs(TabsTrigger, { ...props, className: cn('relative group inline-flex text-sm font-medium text-nowrap items-center transition-colors gap-2 px-2 py-1.5 hover:text-fd-accent-foreground data-[state=active]:text-fd-primary [&_svg]:size-3.5', props.className), children: [_jsx("div", { className: "absolute inset-x-2 bottom-0 h-px group-data-[state=active]:bg-fd-primary" }), children] }));
}
// TODO: currently Vite RSC plugin has problem with `asChild` due to children is automatically wrapped in <Fragment />, maybe revisit this in future
export function CodeBlockTab(props) {
    return _jsx(TabsContent, { ...props });
}
